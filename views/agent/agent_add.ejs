<!-- 회원 생성 업데이트 Modal-->
<div class="modal fade" id="addAgentModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="addAgentModalLabel" aria-hidden="true">
    <div class="modal-dialog  modal-xl  modal-dialog-centered">
      <div class="modal-content bg-100 p-6">
        <div class="modal-header border-0 p-0 mb-2">
          <h3 class="mb-0" id="memInsUpt">에이전트 등록</h3>
          <button class="btn btn-sm btn-phoenix-secondary" data-bs-dismiss="modal" aria-label="Close"><span class="fas fa-times text-danger"></span></button>
        </div>
        <div class="modal-body px-0 " id="modalBody">
            <div class="row mt-2 ">
                <!-- Start :신규 매출 설정-->
                    <div class="col-lg-12 ">
                        <div class="row topDepth">
                            <div class="col cpl-1 cpr-1">
                                <span class="form-control input-text-center fs--1 border-0 bg-color-0"> <%=basicInfo.user.memNm%>  </span>
                            </div>
                            <div class="col cpl-1 cpr-1 subDepth" >
                                <div class="row g-2 ">
                                    <div class="col cpl-1 cpr-1">
                                        <select class="form-select " name="selAgent" onChange="fnGetAgent(this)">
                                            <option value="">선택</option>
                                            <% if( basicInfo.upperList.length > 0 ) {
                                                basicInfo.upperList.forEach(function (el) { %>
                                            <option value="<%=el.seq%>"><%=el.a_nm%>(<%=el.a_id%>)</option>
                                            <% }) }  %>
                                        </select>
                                    </div>
                                    <div class="col cpl-1 cpr-1">
                                        <button class="btn btn-sm btn-warning me-1 mb-1 btnCreate" onclick="fnSetAgentView()">등록</button>
                                    </div>
                                </div>
                               
                            </div>
                            
                        </div>
                    </div>
                    
                    <div class="row  mt-2 d-none" id="setAgentDiv" >
                        <!-- Start :현금방 - 쇼핑방 전환설정 -->
                        <div class="col-lg-3 mt-2 ">
                            <label class="text-1000 fw-bold mb-2 fs--1">&nbsp;</label>
                            <div class="row g-2 ">
                                <div class="col cpl-1 cpr-1">
                                    <span class="form-control input-text-center fs--1 border-0 bg-color-0"> 에이전트 명칭 </span>
                                    
                                </div>
                                <div class="col cpl-1 cpr-1">
                                    <div class="row ">
                                        <div class="col cpl-1 cpr-1">
                                            <input class="form-control input-text-center fs--1" id="agent_nm" type="text" value="" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 mt-2 ">
                            <label class="text-1000 fw-bold mb-2 fs--1">&nbsp;</label>
                            <div class="row g-2 ">
                                <div class="col cpl-1 cpr-1">
                                    <span class="form-control input-text-center fs--1 border-0 bg-color-0"> 에이전트 아이디 </span>
                                    
                                </div>
                                <div class="col cpl-1 cpr-1">
                                    <div class="row ">
                                        <div class="col cpl-1 cpr-1">
                                            <input class="form-control input-text-center fs--1" id="agent_id" type="text" value="" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 mt-2 ">
                            <label class="text-1000 fw-bold mb-2 fs--1">&nbsp;</label>
                            <div class="row g-2 ">
                                <div class="col cpl-1 cpr-1">
                                    <span class="form-control input-text-center fs--1 border-0 bg-color-0"> 지정회원(아이디) </span>
                                    
                                </div>
                                <div class="col cpl-1 cpr-1">
                                    <div class="row ">
                                        <div class="col cpl-1 cpr-1">
                                            <input class="form-control input-text-center fs--1" id="agent_mem_id" type="text" value="" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 mt-2 ">
                            <label class="text-1000 fw-bold mb-2 fs--1">&nbsp;</label>
                            <div class="row g-2 ">
                                <div class="col cpl-1 cpr-1">
                                    <span class="form-control input-text-center fs--1 border-0 bg-color-0"> 수수료 %</span>
                                
                                </div>
                                <div class="col cpl-1 cpr-1">
                                    <input class="form-control input-text-center fs--1" id="agent_rate" type="text" value="" />
                                </div>
                            </div>
                        </div>
                    </div>
                <!-- End :신규 매출 설정   -->
                </div>
        </div>
        <div class="modal-footer border-0 pt-6 px-0 pb-0">
          <button class="btn btn-link text-danger px-3 my-0" data-bs-dismiss="modal" aria-label="Close" onclick="fnReset()">취소</button>
          <button class="btn btn-primary my-0" onclick="fnSetAgentSave()" id="memIns">저장</button>
        </div>
      </div>
    </div>
</div>
<!-- 신규 회원일때 처리 -->
<input type="hidden" id="idchk" value="N">
<input type="hidden" id="rcmIdchk" value="N">

<script>
    
   
    function fnSetAgentView() {
        $('#setAgentDiv').removeClass("d-none");
    }
    
    function fnReset() {
        let data = {}
        data.upperSeq = "AGNT00000000000001"
        $.ajax({
          url: "/a/getAgent",
          dataType: 'json',
          type: 'POST',
          data: data,
          success: function (result) {
              if(result.success) {
                mainAgncyList = result.data;
                console.log(mainAgncyList)
        html = `<div class="modal-body px-0 ">
            <div class="row mt-2 ">
                <!-- Start :신규 매출 설정-->
                    <div class="col-lg-12 ">
                        <div class="row topDepth">
                            <div class="col cpl-1 cpr-1">
                                <span class="form-control input-text-center fs--1 border-0 bg-color-0"> 본사  </span>
                            </div>
                            <div class="col cpl-1 cpr-1 subDepth" >
                                <div class="row g-2 ">
                                    <div class="col cpl-1 cpr-1">
                                        
                                            <select class="form-select" name="selAgent" onChange="fnGetAgent(this)">
                                            <option value="">선택</option>
                                            ${mainAgncyList.length > 0 ? 
                                                mainAgncyList.map(el => `<option value="${el.seq}">${el.a_nm}(${el.a_id})</option>`).join('') 
                                                : ''}
                                            </select>

                                    </div>
                                    <div class="col cpl-1 cpr-1">
                                        <button class="btn btn-sm btn-warning me-1 mb-1 btnCreate" onclick="fnSetAgentView()">등록</button>
                                    </div>
                                </div>
                               
                            </div>
                            
                        </div>
                    </div>
                    
                    <div class="row  mt-2 d-none" id="setAgentDiv" >
                        <!-- Start :현금방 - 쇼핑방 전환설정 -->
                        <div class="col-lg-3 mt-2 ">
                            <label class="text-1000 fw-bold mb-2 fs--1">&nbsp;</label>
                            <div class="row g-2 ">
                                <div class="col cpl-1 cpr-1">
                                    <span class="form-control input-text-center fs--1 border-0 bg-color-0"> 에이전트 명칭 </span>
                                    
                                </div>
                                <div class="col cpl-1 cpr-1">
                                    <div class="row ">
                                        <div class="col cpl-1 cpr-1">
                                            <input class="form-control input-text-center fs--1" id="agent_nm" type="text" value="" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 mt-2 ">
                            <label class="text-1000 fw-bold mb-2 fs--1">&nbsp;</label>
                            <div class="row g-2 ">
                                <div class="col cpl-1 cpr-1">
                                    <span class="form-control input-text-center fs--1 border-0 bg-color-0"> 에이전트 아이디 </span>
                                    
                                </div>
                                <div class="col cpl-1 cpr-1">
                                    <div class="row ">
                                        <div class="col cpl-1 cpr-1">
                                            <input class="form-control input-text-center fs--1" id="agent_id" type="text" value="" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 mt-2 ">
                            <label class="text-1000 fw-bold mb-2 fs--1">&nbsp;</label>
                            <div class="row g-2 ">
                                <div class="col cpl-1 cpr-1">
                                    <span class="form-control input-text-center fs--1 border-0 bg-color-0"> 지정회원 </span>
                                    
                                </div>
                                <div class="col cpl-1 cpr-1">
                                    <div class="row ">
                                        <div class="col cpl-1 cpr-1">
                                            <input class="form-control input-text-center fs--1" id="agent_mem_id" type="text" value="" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 mt-2 ">
                            <label class="text-1000 fw-bold mb-2 fs--1">&nbsp;</label>
                            <div class="row g-2 ">
                                <div class="col cpl-1 cpr-1">
                                    <span class="form-control input-text-center fs--1 border-0 bg-color-0"> 수수료 %</span>
                                
                                </div>
                                <div class="col cpl-1 cpr-1">
                                    <input class="form-control input-text-center fs--1" id="agent_rate" type="text" value="" />
                                </div>
                            </div>
                        </div>
                    </div>
                <!-- End :신규 매출 설정   -->
                </div>
        </div>`

        $('#modalBody').empty();
        $('#modalBody').append(html);
              }
              
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                alert('새로 고침 후 다시 시도하여 주세요');
            } //function끝
          });
      }

    function fnGetAgent(el) {
        console.log(el)
        $('.btnCreate').hide();
        let data = {};
        data.upperSeq = $(el).val();
        $.ajax({
          url: "/a/getAgent",
          dataType: 'json',
          type: 'POST',
          data: data,
          success: function (result) {
              if(result.success) {
                console.log(result)
                let sub = `
                    <div class="col cpl-1 cpr-1 subDepth">
                        <div class="row g-2 ">
                            <div class="col cpl-1 cpr-1">
                                <select class="form-select selAgent"  name="selAgent" onChange="fnGetAgent(this)">
                                    <option value="">선택</option> `
                                    if (result.data.length > 0) {
                                        result.data.forEach(function (el) { 
                                    sub += ' <option value="'+el.seq+'">'+el.a_nm+'('+el.a_id+') </option> '
                                        })}
                    sub += `                            
                                </select>
                            </div>
                            <div class="col cpl-1 cpr-1">
                                <button class="btn btn-sm btn-warning me-1 mb-1 btnCreate" onclick="fnSetAgentView()">등록</button>
                            </div>
                        </div>
                    </div>
                    `
                $('.topDepth').append(sub)
              } else {
                  let sub = `
                    <div class="col cpl-1 cpr-1 subDepth">
                        <div class="row g-2 ">
                            <div class="col cpl-1 cpr-1">
                                <select class="form-select selAgent" name="selAgent">
                                    <option value="">선택</option>
                                </select>
                            </div>
                            <div class="col cpl-1 cpr-1">
                                <button class="btn btn-sm btn-warning me-1 mb-1 btnCreate" onclick="fnSetAgentView()">등록</button>
                            </div>
                        </div>
                    </div>
                    `
                $('.topDepth').append(sub)
              }
              
          },
          error: function (XMLHttpRequest, textStatus, errorThrown) {
              alert('새로 고침 후 다시 시도하여 주세요');
          } //function끝
        });
    }

  function fnSetAgentSave(){
    let agentCode = "AGNT00000000000001"
    $("select[name=selAgent]").each(function(index, item){
        console.log( agentCode += ","+$(item).val())
        if($(item).val() != "")  agentCode += ","+$(item).val();
    });

    if ($('#agent_nm').val() == "" || $('#agent_nm').val() == "undefined" ) {
        fnAlertMessage("에이전트 이름을 입력 후 진행 하여 주세요.");
        return;
    }

    let data = {};
    data.agentCode = agentCode;
    data.aNm =  $('#agent_nm').val();
    data.aId =  $('#agent_id').val();
    data.memId = $('#agent_mem_id').val();
    data.rate = $('#agent_rate').val();

    $.ajax({
        url: "/a/setAgent",
        dataType: 'json',
        type: 'POST',
        data: data,
        success: function (result) {
            if(result.success) {
                fnAlertReloadMessage(result.message)
            } else {
                fnAlertMessage(result.message)
            }
            
        },
        error: function (XMLHttpRequest, textStatus, errorThrown) {
            alert('새로 고침 후 다시 시도하여 주세요');
        } //function끝
    });
  }
</script>